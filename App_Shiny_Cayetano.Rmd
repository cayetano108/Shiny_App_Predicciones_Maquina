---
title: "APP SHINY MAQUINAS"
author: "Cayetano Romero"
date: "2023-05-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## TAREA ENTREGABLE
 
 Copia el c√≥digo con la interfaz que has creado antes. Completa la aplicaci√≥n a√±adiendo los elementos de salida que se muestran en la aplicaci√≥n completa: [este enlace][https://fermaji.shinyapps.io/AppEjFinal/].
 
 Lo que se muestra es un ejemplo, pero se da total libertad para modificar la apariencia de la app!
   
   La funcionalidad m√≠nima debe incluir:
   
 - Generaci√≥n autom√°tica de los elementos de la UI a partir del fichero cargado Ô∏è
 - Crear correctamente el selector de m√°quinas por identificador de matr√≠cula √∫nica.
 - Representar la probabilidad de orden (`p_orden`) al seleccionar cada m√°quina.
 - Funcionamiento correcto al seleccionar/deseleccionar las alarmas, tanto como figura como en la tabla.
 - Funcionamiento correcto del widget del calendario para acotar por fechas.
 - Funcionamiento correcto del slider selector de ancho de bin para el histograma.
 - Representaci√≥n correcta del histograma y boxplot por alarma.
 - Funcionamiento correcto del boxplot para todas las m√°quinas.
 
 OPCIONALMENTE:
   
 - Filtrar por alarmas activas/inactivas en la m√°quina seleccionada y mostrarlo al usuario. COMPLETADO
 - Advertir de errores en el formato ala cargar el fichero. COMPLETADO
 - Posibilidad de seleccionar entre histograma o boxplot en las estad√≠sticas. COMPLETADO
 - Hacer interactiva la gr√°fica de probabilidad de orden y la de las alarmas. COMPLETADO
 - Uso de iconos. COMPLETADO
 - A√±adir estilos personalizados (ficheros css). COMPLETADO
 - Publicar la app en un servidor (https://www.shinyapps.io/). COMPLETADO

<center>
[--> APLICACI√ìN <--](https://cayetano108.shinyapps.io/Tarea_shiny_Cayetano_Romero/)
</center>


<br>
<br>
```{css, echo=FALSE} 
@font-face {
  font-family: F1;
  src: url(https://www.formula1.com/etc/designs/fom-website/fonts/F1Regular/Formula1-Regular.ttf);
}

/* Fondo negro y color de letra cyan para toda la p√°gina */
body {
  font-family: F1;
  background-color: black;
  color: darkcyan;
}

.navbar-inverse .sidebar {
    background-color: rgb(193, 193, 193);
  }

.navbar-default {
    background-color: darkslategray;
  }

/* Subapartados con fondo gris */
.navbar .nav > li > .dropdown-menu {
  font-family: F1;
  background-color: gray;
}
```



```{r, warning = FALSE, message = FALSE}

library(shiny)
library(shinythemes)
library(ggplot2)
library(tidyverse)
library(DT)
library(plotly)


ui<-navbarPage(theme = './www/2css.css',
               "App Master Ciencia de Datos üíª üìä", 
               tabPanel("Selecci√≥n de m√°quina ü§ñ",
                        sidebarLayout(
                          sidebarPanel('M√ÅQUINA',
                                       fileInput("DatosFichero", "Selecciona el fichero de datos", accept = NULL),
                                       tableOutput("contents"),
                                       uiOutput("selectMaquina")
                                      ),

                          mainPanel(h5("Probabilidad de orden"),
                                    plotOutput("probsPlot"))
                        )),

               navbarMenu("Estado de la maquina üîõ",
                          tabPanel("Evoluci√≥n Temporal alarmas",
                                   sidebarLayout(
                                     sidebarPanel('ALARMAS radiobuttons',
                                                  textOutput('alarmas_desact'),
                                                  uiOutput("radioButtons_alarms")),

                                     mainPanel(h5("üïíüö® Evoluci√≥n temporal Alarmas üö®üïí"),
                                               plotlyOutput('plotAlarms'))
                                     )),

                          tabPanel("Registros de la m√°quina",
                                   sidebarLayout(
                                     sidebarPanel('ALARMAS checkbox', 
                                                  textOutput('alarmas_desact2'), 
                                                  uiOutput("checkBoxes_alarms")),

                                     mainPanel(h5("Registros de la m√°quina seleccionada"),
                                               dataTableOutput('tabla_alarmas'))
               ))),
               tabPanel("Estad√≠sticas Globales Temporales üìàüïí",
                        sidebarLayout(
                          sidebarPanel('PERIODO Y ESTAD√çSTICAS',                             
                              uiOutput('data_range'),
                                'HISTOGRAMA üìä',
                              uiOutput('selectAlarma'),
                              uiOutput('slider_bins'),
                                'BOXPLOT',
                              uiOutput('elegir_grafico'), 
                              conditionalPanel(
                                condition = "input.elegir_grafico == 'Boxplot'",
                                uiOutput('checkBoxplots')
                              )

                          ),
                          mainPanel(h5("Histograma de la alarma seleccionada"),
                                      # plotOutput('plotHist'),
                                      plotOutput('boxplot')
                                   
                                    )
                        )),
               
)

server <- function(input, output, session) {
  
  data <- reactive({
    req(input$DatosFichero)
    load(input$DatosFichero$datapath)
    get(ls()[1])
  })
  
  output$contents <- renderTable({
    file <- input$DatosFichero
    ext <- tools::file_ext(file$datapath)
    req(file)
    validate(need(ext == "Rdata", "El archivo que has seleccionado no es un .Rdata, m√°s concretamente 'PrediccionesMaquina.Rdata'. Selecciona ese archivo para continuar"))
    # C√≥digo para cargar y mostrar el contenido del archivo .Rdata
  })
  
  
  output$selectMaquina <- renderUI({
    req(data())
    selectInput("select", "Ô∏è‚û°Ô∏è ü§ñ Selecciona m√°quina:", choices = unique(data()[,"matricula"]))
  })
  
  
  output$probsPlot <- renderPlot({
    req(data(), input$select)
    attach(data())
    df <- data()[data()[,"matricula"] == input$select,]
    #ggplotly( 
      ggplot(df, aes(x = dia, y = p_orden, color = p_orden)) +
               geom_line() + geom_point() + 
      scale_color_gradient(low = "darkblue", high = "red") +
      labs(title = "", x = 'D√≠a', y = 'P. orden', color = "p_orden") #)
  })
  
  dataButtons <- reactive({
    req(input$DatosFichero)
    load(input$DatosFichero$datapath)
    df <- as.data.frame(get(ls()[1]))
    df <- na.omit(df)
    df <- df[df[,"matricula"] == input$select,]
    cols_originales <- names(df)
    df <- df %>% select(matches("^a\\d+$"))
    df <- df %>% select(-setdiff(names(df), names(df)[colSums(df) != 0.0000]))
    cols_eliminadas <- setdiff(cols_originales, names(df))
    colnames(df)
  })
  
  cols_elim <- reactive({
    req(input$DatosFichero)
    load(input$DatosFichero$datapath)
    df <- as.data.frame(get(ls()[1]))
    df <- na.omit(df)
    df <- df[df[,"matricula"] == input$select,]
    df <- df %>% select(matches("^a\\d+$"))
    cols_originales <- names(df)
    df <- df %>% select(-setdiff(names(df), names(df)[colSums(df) != 0.0000]))
    cols_eliminadas <- setdiff(cols_originales, names(df))
    cols_eliminadas
  })
  
  
  output$radioButtons_alarms <- renderUI({
    radioButtons("variable", "‚û°Ô∏è üö® Selecciona la alarma a visualizar:",
                 choices = dataButtons())
  })
  
  output$alarmas_desact <- renderText({
    req(cols_elim(), input$select)
    desac <- paste('Las alarmas ‚û°Ô∏è', paste(cols_elim(), collapse = ', '), ' no se muestran porque est√°n desactivadas para la m√°quina ', input$select)
    desac
   })
  
  output$alarmas_desact2 <- renderText({
    req(cols_elim(), input$select)
    desac <- paste('Las alarmas ‚û°Ô∏è', paste(cols_elim(), collapse = ', '), ' no se muestran porque est√°n desactivadas para la m√°quina ', input$select)
    desac
  })
  
  output$plotAlarms <- renderPlotly({
    req(data(), input$select, input$variable)
    df <- data()[data()[,"matricula"] == input$select,]
    ggplotly(ggplot(df, aes(x = dia, y = !!sym(input$variable))) +
      geom_line(color = 'darkcyan') + geom_point(color = 'darkcyan') + 
      #scale_color_gradient(low = "darkblue", high = "red") +
      labs(title = "", x = 'D√≠a', y = input$variable))
  })

  output$checkBoxes_alarms <- renderUI({
    checkboxGroupInput("check_variable", "‚û°Ô∏è üö® Selecciona las alarmas para ver en la tabla",
                 choices = dataButtons())
  })

  output$tabla_alarmas <- renderDataTable({
    req(data(), input$check_variable)
    df <- data()
    df <- df %>% select( matricula, dia, input$check_variable, p_orden)
    df <- df[df[,"matricula"] == input$select,]
    
    df <- na.omit(df)  # Eliminar filas con NAs
    datatable(df, style = 'bootstrap4',options = list(pageLength = 25))
  })
  
  output$selectAlarma <- renderUI({
    req(dataButtons())
    selectInput("selectAlarma", "Selecciona m√°quina", choices = dataButtons())
  })

  output$slider_bins <- renderUI({
    sliderInput("slider_bins", "Ancho de bin del histograma „Ää‚áπ„Äã",
                min= 1, max = 50, value = 20, step= 1)
  })
  
  output$data_range <- renderUI({
    req(data())
    df <- data()
    dateRangeInput("data_range", "Selecciona el periodo üìÖ",
                   start = min(df$dia), end = max(df$dia), weekstart = 1, separator= "a", language = 'es')
  })
  
  output$elegir_grafico <- renderUI({
    radioButtons("elegir_grafico", "‚û°Ô∏è Eleccion de gr√°fico",
                 choices = c('Histograma', 'Boxplot'))
  })
  
  output$checkBoxplots <- renderUI({
    checkboxInput("checkBoxplots", "Todas las m√°quinas")
  })
  
    output$boxplot <- renderPlot({
      data() 
      input$selectAlarma
      input$data_range 
      input$select
      input$checkBoxplots
      input$elegir_grafico

      if (input$elegir_grafico == 'Histograma') {
        req(data(), input$selectAlarma, input$slider_bins, input$data_range, input$select)
        df <- na.omit(data())
        df <- df[df[,"matricula"] == input$select,]
        df <- df %>% filter(dia >= input$data_range[1] & dia <= input$data_range[2])
        ggplot(df, aes(x= !!sym(input$selectAlarma))) +
          geom_histogram(color = 'darkcyan', fill = 'darkslategray', binwidth=input$slider_bins)
        
        
      } else if (input$elegir_grafico == 'Boxplot') {
        if (input$checkBoxplots == FALSE){
          df <- na.omit(data())
          df <- df %>% select(matricula, dia, matches(paste0("^", input$selectAlarma)))
          df <- df %>% filter(dia >= input$data_range[1] & dia <= input$data_range[2])
          df <- df[df[,"matricula"] == input$select,]
        
          ggplot(df, aes(x = matricula, y = !!sym(input$selectAlarma))) +
          geom_boxplot(color = 'darkcyan', fill = 'darkslategray') 
      
        
      } else if (input$checkBoxplots == TRUE) {
        df <- na.omit(data())
        df <- df %>% select(matricula, dia, matches(paste0("^", input$selectAlarma)))
        df <- df %>% filter(dia >= input$data_range[1] & dia <= input$data_range[2])
        df$matricula <- as.factor(df$matricula)

        ggplot(df, aes(x =matricula, y = !!sym(input$selectAlarma))) +
          geom_boxplot(color = 'darkcyan', fill = 'darkslategray') 
        
      }} 
        

   })
}

shinyApp(ui, server)


```


